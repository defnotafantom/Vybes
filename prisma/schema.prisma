// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  DEFAULT
  ARTIST
  RECRUITER
  ARTIST_RECRUITER
}

enum AdminRole {
  USER          // Nessun accesso admin
  MODERATOR     // Pu√≤ moderare contenuti
  ADMIN         // Gestione utenti e contenuti
  SUPERADMIN    // Accesso completo incluso DB
}

enum EventStatus {
  DRAFT
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PostType {
  POST
  COLLABORATION
  EVENT
  ANNOUNCEMENT
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String
  name          String?
  username      String?   @unique
  image         String?
  role          UserRole  @default(DEFAULT)
  adminRole     AdminRole @default(USER)
  bio           String?
  location      String?
  website       String?
  
  // OAuth accounts
  accounts      Account[]
  
  // Gamification
  level         Int       @default(1)
  experience    Int       @default(0)
  reputation    Int       @default(0)
  coins         Int       @default(0) // Monete per acquisti
  
  // Avatar 3D
  avatar        Avatar?   // Avatar 3D personalizzato
  useAvatar     Boolean   @default(false) // Se true, usa avatar invece di image
  
  // Social
  followers     User[]    @relation("UserFollows")
  following     User[]    @relation("UserFollows")
  
  // Artist specific
  portfolio     PortfolioItem[]
  collaborations Post[]   @relation("ArtistCollaborations")
  
  // Recruiter specific
  events        Event[]
  
  // User content
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  reactions     Reaction[]
  reposts       Repost[]
  savedPosts    SavedPost[]
  pollVotes     PollVote[]
  bookmarkCollections BookmarkCollection[]
  
  // Events participation
  eventParticipants EventParticipant[]
  savedEvents       SavedEvent[]
  
  // Quest system
  questProgress QuestProgress[]
  completedQuests Quest[] @relation("CompletedQuests")
  
  // Chat
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  conversations    ConversationParticipant[]
  
  // Notifications
  notifications    Notification[]
  avatarItems     UserAvatarItem[]
  transactions    Transaction[]
  
  // Stories
  stories          Story[]
  storyViews       StoryView[] @relation("StoryViews")
  
  // Blocking/Muting
  blockedUsers     UserBlock[] @relation("BlockedUsers")
  blockedBy        UserBlock[] @relation("BlockedBy")
  mutedUsers       UserMute[]  @relation("MutedUsers")
  mutedBy          UserMute[]  @relation("MutedBy")
  
  // Achievements
  achievements     UserAchievement[]
  dailyRewards     UserDailyReward[]
  
  // Analytics
  profileVisits    ProfileVisit[] @relation("ProfileVisits")
  visitedProfiles  ProfileVisit[] @relation("VisitedProfiles")
  
  // Pinned posts
  pinnedPostId     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PortfolioItem {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  imageUrl    String?
  videoUrl    String?
  tags        String[]
  type        String   // image, video, text, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Post {
  id            String   @id @default(cuid())
  authorId      String
  author        User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  type          PostType @default(POST)
  content       String
  images        String[]
  tags          String[] // Art tags for filtering
  location      String?
  latitude      Float?
  longitude     Float?
  
  // Collaboration specific
  collaborationArtists User[] @relation("ArtistCollaborations")
  
  // Social engagement
  likes         Like[]
  reactions     Reaction[]
  comments      Comment[]
  savedBy       SavedPost[]
  reposts       Repost[]   @relation("OriginalPost")
  collections   CollectionPost[]
  
  // Poll (optional)
  poll          Poll?
  
  // Pinned post
  isPinned      Boolean  @default(false)
  
  // Scheduled post
  scheduledFor  DateTime?
  isDraft       Boolean  @default(false)
  
  // Views tracking
  viewsCount    Int      @default(0)
  
  // Analytics
  analytics     PostAnalytics?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Performance indexes
  @@index([authorId])
  @@index([createdAt])
  @@index([type])
  @@index([isPinned])
}

model Event {
  id            String      @id @default(cuid())
  recruiterId   String
  recruiter     User        @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  title         String
  description   String
  type          String      // event, job, training, etc.
  status        EventStatus @default(DRAFT)
  
  // Location
  address       String
  city          String
  country       String
  latitude      Float
  longitude     Float
  
  // Date & Time
  startDate     DateTime
  endDate       DateTime?
  
  // Details
  imageUrl      String?
  requirements  String?
  compensation  String?
  maxParticipants Int?
  
  // Participants
  participants  EventParticipant[]
  savedBy       SavedEvent[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Performance indexes
  @@index([recruiterId])
  @@index([city])
  @@index([status])
  @@index([startDate])
  @@index([createdAt])
}

model EventParticipant {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt DateTime @default(now())
  
  @@unique([eventId, userId])
}

model SavedEvent {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([eventId, userId])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String
  
  // Reply support
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  
  // Likes on comments
  likesCount Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance indexes
  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([postId, userId])
}

// Reactions (emoji reactions beyond like)
model Reaction {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji     String   // üòÇ‚ù§Ô∏èüòÆüò¢üò°üî•üëè
  createdAt DateTime @default(now())
  
  @@unique([postId, userId, emoji])
  @@index([postId])
}

// Repost/Quote system
model Repost {
  id             String   @id @default(cuid())
  originalPostId String
  originalPost   Post     @relation("OriginalPost", fields: [originalPostId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quote          String?  // Optional quote text
  createdAt      DateTime @default(now())
  
  @@unique([originalPostId, userId])
  @@index([userId])
}

// Polls
model Poll {
  id        String       @id @default(cuid())
  postId    String       @unique
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  question  String
  options   PollOption[]
  endsAt    DateTime?
  createdAt DateTime     @default(now())
}

model PollOption {
  id        String     @id @default(cuid())
  pollId    String
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  text      String
  votes     PollVote[]
  
  @@index([pollId])
}

model PollVote {
  id        String     @id @default(cuid())
  optionId  String
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())
  
  @@unique([optionId, userId])
}

// Bookmark Collections
model BookmarkCollection {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  isDefault Boolean          @default(false)
  posts     CollectionPost[]
  createdAt DateTime         @default(now())
  
  @@index([userId])
}

model CollectionPost {
  id           String             @id @default(cuid())
  collectionId String
  collection   BookmarkCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  postId       String
  post         Post               @relation(fields: [postId], references: [id], onDelete: Cascade)
  addedAt      DateTime           @default(now())
  
  @@unique([collectionId, postId])
}

// Link Previews cache
model LinkPreview {
  id          String   @id @default(cuid())
  url         String   @unique
  title       String?
  description String?
  image       String?
  siteName    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Stories (24h posts)
model Story {
  id          String      @id @default(cuid())
  authorId    String
  author      User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  mediaUrl    String
  mediaType   String      // image, video
  caption     String?
  views       StoryView[]
  expiresAt   DateTime
  createdAt   DateTime    @default(now())
  
  @@index([authorId])
  @@index([expiresAt])
}

model StoryView {
  id        String   @id @default(cuid())
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("StoryViews", fields: [userId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now())
  
  @@unique([storyId, userId])
}

// User blocking/muting
model UserBlock {
  id          String   @id @default(cuid())
  blockerId   String
  blocker     User     @relation("BlockedUsers", fields: [blockerId], references: [id], onDelete: Cascade)
  blockedId   String
  blocked     User     @relation("BlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  
  @@unique([blockerId, blockedId])
}

model UserMute {
  id        String   @id @default(cuid())
  muterId   String
  muter     User     @relation("MutedUsers", fields: [muterId], references: [id], onDelete: Cascade)
  mutedId   String
  muted     User     @relation("MutedBy", fields: [mutedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([muterId, mutedId])
}

// Achievements/Badges
model Achievement {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  icon        String   // emoji or icon name
  category    String   // social, creative, engagement, special
  requirement String   // JSON with conditions
  xpReward    Int      @default(50)
  rarity      String   @default("common") // common, rare, epic, legendary
  
  unlockedBy  UserAchievement[]
  createdAt   DateTime @default(now())
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  unlockedAt    DateTime    @default(now())
  
  @@unique([userId, achievementId])
}

// Daily rewards
model DailyReward {
  id        String   @id @default(cuid())
  day       Int      // 1-7 for weekly cycle
  xpReward  Int
  coinReward Int
  
  @@unique([day])
}

model UserDailyReward {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  claimedAt   DateTime @default(now())
  streak      Int      @default(1)
  lastClaimDay Int
  
  @@index([userId])
}

// Analytics for creators
model PostAnalytics {
  id          String   @id @default(cuid())
  postId      String   @unique
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  impressions Int      @default(0)
  reaches     Int      @default(0)
  shares      Int      @default(0)
  saves       Int      @default(0)
  profileVisits Int    @default(0)
  updatedAt   DateTime @updatedAt
}

model ProfileVisit {
  id         String   @id @default(cuid())
  profileId  String
  profile    User     @relation("ProfileVisits", fields: [profileId], references: [id], onDelete: Cascade)
  visitorId  String?
  visitor    User?    @relation("VisitedProfiles", fields: [visitorId], references: [id], onDelete: SetNull)
  visitedAt  DateTime @default(now())
  
  @@index([profileId])
  @@index([visitedAt])
}

model SavedPost {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([postId, userId])
}

model Quest {
  id            String   @id @default(cuid())
  title         String
  description   String
  type          String   @unique // profile_complete, first_post, first_event, collaboration, etc.
  role          UserRole[] // Which roles can complete this quest
  experienceReward Int   @default(100)
  reputationReward  Int  @default(10)
  
  completedBy   User[]   @relation("CompletedQuests")
  progress      QuestProgress[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model QuestProgress {
  id        String   @id @default(cuid())
  questId   String
  quest     Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  progress  Int      @default(0)
  maxProgress Int    @default(1)
  completed Boolean  @default(false)
  completedAt DateTime?
  
  @@unique([questId, userId])
}

model Conversation {
  id        String   @id @default(cuid())
  participants ConversationParticipant[]
  messages  Message[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadAt     DateTime?
  
  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  recipientId    String
  recipient      User         @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)
  content        String
  status         MessageStatus @default(SENT)
  createdAt      DateTime     @default(now())

  // Performance indexes
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AdminPermission {
  id          String   @id @default(cuid())
  role        AdminRole
  permission  String   // db_read, db_write, users_manage, content_moderate, roles_manage, etc.
  createdAt   DateTime @default(now())
  
  @@unique([role, permission])
  @@index([role])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // message, follow, comment, event, quest
  title     String
  content   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@index([userId, createdAt])
}

model Avatar {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Avatar parts configuration (JSON stored as string, parsed on frontend)
  face        String?  // Face ID
  eyes        String?  // Eyes ID
  hair        String?  // Hair ID
  top         String?  // Top/Busto ID
  bottom      String?  // Bottom/Pantaloni ID
  accessories String?  // Accessories IDs (comma-separated)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AvatarItem {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String   // face, eyes, hair, top, bottom, accessory
  previewUrl  String?  // Preview image URL
  modelUrl    String?  // 3D model URL (if needed)
  priceCoins  Int      @default(0) // Prezzo in monete
  priceReal   Float?   // Prezzo reale (opzionale)
  rarity      String   @default("common") // common, rare, epic, legendary
  available   Boolean  @default(true)
  
  // User ownership (many-to-many)
  ownedBy     UserAvatarItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserAvatarItem {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  itemId      String
  item        AvatarItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  purchasedAt DateTime   @default(now())
  
  @@unique([userId, itemId])
  @@index([userId])
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // quest_reward, purchase, refund, etc.
  amount      Int      // Positivo per crediti, negativo per debiti
  description String
  metadata    String?  // JSON con dettagli aggiuntivi
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([userId, createdAt])
}

